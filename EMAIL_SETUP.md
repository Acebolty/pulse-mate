# Email Notifications Setup Guide

This guide explains how to set up email notifications for health alerts in the PulseMate system.

## Overview

The email notification system automatically sends emails to users when:
- Critical health readings are detected (high/low heart rate, blood pressure, glucose, etc.)
- Health alerts are generated by the system
- Users can test email functionality from their settings page

## Setup Instructions

### 1. Development Setup (Using Ethereal Email)

For development and testing, the system automatically uses Ethereal Email (fake SMTP service):

1. No additional configuration needed
2. Emails won't be delivered to real inboxes
3. Preview URLs will be logged to the console
4. Perfect for testing email templates and functionality

### 2. Production Setup (Using Gmail)

For production with real email delivery:

1. **Get Gmail App Password:**
   - Go to your Google Account settings
   - Enable 2-Factor Authentication
   - Generate an App Password for "Mail"
   - Copy the 16-character app password

2. **Update Environment Variables:**
   Edit `backend/.env` file:
   ```env
   NODE_ENV=production
   EMAIL_USER=your-gmail@gmail.com
   EMAIL_PASSWORD=your-16-character-app-password
   EMAIL_FROM=PulseMate Health Monitor <your-gmail@gmail.com>
   FRONTEND_URL=https://your-domain.com
   ```

### 3. Alternative Email Services

You can also use other email services by modifying `backend/services/emailService.js`:

**SendGrid:**
```javascript
this.transporter = nodemailer.createTransporter({
  service: 'SendGrid',
  auth: {
    user: 'apikey',
    pass: process.env.SENDGRID_API_KEY
  }
});
```

**Mailgun:**
```javascript
this.transporter = nodemailer.createTransporter({
  service: 'Mailgun',
  auth: {
    user: process.env.MAILGUN_USERNAME,
    pass: process.env.MAILGUN_PASSWORD
  }
});
```

## How It Works

### 1. User Settings
- Users can enable/disable email notifications in Settings → Notifications
- Both "Email Notifications" and "Health Alerts" must be enabled
- Users can test email functionality with the "Send Test Email" button

### 2. Alert Generation
Emails are automatically sent when alerts are created in two places:

**A. Real-time Health Data Processing:**
- When users submit health data via manual entry or simulation
- Immediate analysis and alert generation
- Located in: `backend/controllers/healthDataController.js`

**B. Batch Alert Generation:**
- Periodic analysis of health patterns
- Missing reading reminders
- Located in: `backend/services/healthAlertGenerator.js`

### 3. Email Templates
- Professional HTML email templates with PulseMate branding
- Responsive design that works on mobile and desktop
- Includes alert details, recommendations, and action buttons
- Plain text fallback for email clients that don't support HTML

## Testing Email Functionality

### 1. Using the Test Button
1. Go to Settings → Notifications
2. Enable "Email Notifications"
3. Click "Send Test Email"
4. Check console for preview URL (development) or your inbox (production)

### 2. Triggering Real Alerts
1. Go to Dashboard
2. Use "Generate Current Readings" or "Manual Data Entry"
3. Enter values that trigger alerts:
   - Heart Rate: < 60 or > 100 bpm
   - Blood Pressure: > 140/90 mmHg
   - Glucose: < 70 or > 180 mg/dL
   - Temperature: < 97°F or > 100.4°F

### 3. API Testing
```bash
# Test email endpoint directly
curl -X POST http://localhost:5001/api/email-test/send-test-alert \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json"
```

## Troubleshooting

### Common Issues

1. **"Email transporter not configured"**
   - Check that nodemailer is installed: `npm install nodemailer`
   - Verify environment variables are set correctly

2. **Gmail authentication failed**
   - Ensure 2FA is enabled on your Google account
   - Use App Password, not your regular password
   - Check that "Less secure app access" is disabled (use App Password instead)

3. **Emails not being sent**
   - Check user has both email notifications AND health alerts enabled
   - Verify user email address is valid
   - Check server console for error messages

4. **Preview URL not showing**
   - Preview URLs only work in development mode
   - Set `NODE_ENV=development` in your .env file

### Debug Mode

To see detailed email logs, check the server console when alerts are generated. You'll see:
- "Alert created: [Alert Title]"
- "Health alert email sent successfully to: [email]"
- "Email preview: [URL]" (development only)

## Security Notes

- Never commit real email credentials to version control
- Use environment variables for all sensitive configuration
- Consider using dedicated email services (SendGrid, Mailgun) for production
- App passwords are more secure than regular passwords for Gmail

## Future Enhancements

Potential improvements to the email system:
- Email templates for different alert types
- Digest emails (daily/weekly summaries)
- Appointment reminder emails
- Medication reminder emails
- Unsubscribe functionality
- Email delivery tracking and analytics
